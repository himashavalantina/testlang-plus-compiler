/**
 * GeneratedTests.java
 * DO NOT MODIFY. This file is automatically generated by the TestLang++ Compiler.
 */
package com.testlang.generated;

import org.junit.jupiter.api.*;
import static org.junit.jupiter.api.Assertions.*;
import java.net.http.*;
import java.net.URI;
import java.io.IOException;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;
import java.util.regex.*;

@TestInstance(TestInstance.Lifecycle.PER_CLASS)
@TestMethodOrder(MethodOrderer.OrderAnnotation.class)
public class GeneratedTests {

    private static HttpClient client;
    private static String baseUrl = "http://localhost:8080";
    private static Map<String, String> defaultHeaders = new ConcurrentHashMap<>();
    private static Map<String, String> globalVars = new ConcurrentHashMap<>();

    @BeforeAll
    void setup() {
        // Initialize HttpClient with default settings
        client = HttpClient.newBuilder()
            .version(HttpClient.Version.HTTP_2)
            .build();

        // Load default headers from TestLang++ config
        defaultHeaders.put("Content-Type", "application/json");
        // Load global variables from 'let' statements
        globalVars.put("id", "42");
        globalVars.put("user", "test@example.com");
        globalVars.put("token", "mocked_session_token_12345");

        // Allow overriding base URL via environment variable
        String envUrl = System.getenv("TEST_BASE_URL");
        if (envUrl != null && !envUrl.isBlank()) {
            baseUrl = envUrl;
        }
    }

    private static String interpolate(String input, Map<String,String> runtime, Map<String,String> globals) {
        if (input == null) return null;
        Pattern p = Pattern.compile("\\$\\w+");
        Matcher m = p.matcher(input);
        StringBuffer sb = new StringBuffer();
        while (m.find()) { 
            String name = m.group().substring(1);
            String val = runtime.get(name);
            if (val == null) val = globals.get(name);
            if (val == null) val = m.group(); // leave as-is if unknown
            m.appendReplacement(sb, Matcher.quoteReplacement(val));
        }
        m.appendTail(sb);
        return sb.toString();
    }

    private static String extractJsonString(String json, String key) {
        if (json == null || key == null) return "";
        // Regex to find "key": "value" and capture value
        Pattern p = Pattern.compile("\\\"" + Pattern.quote(key) + "\\\"\\s*:\\s*\\\"([^\\\"]*)\\\"");
        Matcher m = p.matcher(json);
        if (m.find()) return m.group(1);
        return "";
    }

    // server reachability check removed; tests are intended to run against the mock API

    @Test
    @Order(1)
    void test_Login() throws IOException, InterruptedException {
        HttpResponse<String> response = null;
        HttpRequest.Builder requestBuilder;
        Map<String,String> runtimeVars = new ConcurrentHashMap<>();

        // --- Start Request: POST /login ---
        String __path = interpolate("/login", runtimeVars, globalVars);
        requestBuilder = HttpRequest.newBuilder()
            .uri(URI.create(baseUrl + __path));
        defaultHeaders.forEach(requestBuilder::header);
        String requestBody = interpolate("{\"username\":\"$user\",\"password\":\"P@ssword123\"}", runtimeVars, globalVars);
        HttpRequest.BodyPublisher bodyPublisher = HttpRequest.BodyPublishers.ofString(requestBody);
        requestBuilder.POST(bodyPublisher);
        response = client.send(requestBuilder.build(), HttpResponse.BodyHandlers.ofString());
        // --- End Request ---

        // Assertion: StatusAssertion
        assertEquals(200, response.statusCode(), "Status code mismatch");

        // Assertion: HeaderAssertion
        String actualHeader = response.headers().firstValue("Content-Type").orElse("");
        assertTrue(actualHeader.contains("json"), "Header 'Content-Type' does not contain 'json'");

        // Assertion: BodyAssertion
        assertTrue(response.body() != null && response.body().contains("\"token\":"), "Response body does not contain expected text.");
        String newToken = extractJsonString(response.body(), "token");
        if (newToken != null && !newToken.isEmpty()) {
            globalVars.put("token", newToken);
        }

    }

    @Test
    @Order(2)
    void test_GetUser() throws IOException, InterruptedException {
        HttpResponse<String> response = null;
        HttpRequest.Builder requestBuilder;
        Map<String,String> runtimeVars = new ConcurrentHashMap<>();

        // --- Start Request: GET /api/users/$id ---
        String __path = interpolate("/api/users/$id", runtimeVars, globalVars);
        requestBuilder = HttpRequest.newBuilder()
            .uri(URI.create(baseUrl + __path));
        defaultHeaders.forEach(requestBuilder::header);
        // Add specific headers (runtime interpolated)
        requestBuilder.header("Authorization", interpolate("Bearer $token", runtimeVars, globalVars));
        HttpRequest.BodyPublisher bodyPublisher;
        requestBuilder.GET();
        response = client.send(requestBuilder.build(), HttpResponse.BodyHandlers.ofString());
        // --- End Request ---

        // Assertion: StatusAssertion
        assertEquals(200, response.statusCode(), "Status code mismatch");

        // Assertion: BodyAssertion
        assertTrue(response.body() != null && Pattern.compile("\\\"id\\\"\\s*:\\s*(42|\\\"42\\\")").matcher(response.body()).find(), "Response body does not contain expected id.");

    }

    @Test
    @Order(3)
    void test_UpdateUser() throws IOException, InterruptedException {
        HttpResponse<String> response = null;
        HttpRequest.Builder requestBuilder;
        Map<String,String> runtimeVars = new ConcurrentHashMap<>();

        // --- Start Request: PUT /api/users/$id ---
        String __path = interpolate("/api/users/$id", runtimeVars, globalVars);
        requestBuilder = HttpRequest.newBuilder()
            .uri(URI.create(baseUrl + __path));
        defaultHeaders.forEach(requestBuilder::header);
        // Add specific headers (runtime interpolated)
        requestBuilder.header("Authorization", interpolate("Bearer $token", runtimeVars, globalVars));
        String requestBody = interpolate("{ \"role\": \"ADMIN\" }", runtimeVars, globalVars);
        HttpRequest.BodyPublisher bodyPublisher = HttpRequest.BodyPublishers.ofString(requestBody);
        requestBuilder.PUT(bodyPublisher);
        response = client.send(requestBuilder.build(), HttpResponse.BodyHandlers.ofString());
        // --- End Request ---

        // Assertion: StatusAssertion
        assertEquals(200, response.statusCode(), "Status code mismatch");

        // Assertion: HeaderAssertion
        String actualHeader = response.headers().firstValue("X-App").orElse("");
        assertEquals("TestLangDemo", actualHeader, "Header 'X-App' value mismatch");

        // Assertion: BodyAssertion
        assertTrue(response.body() != null && Pattern.compile("\\\"updated\\\"\\s*:\\s*true").matcher(response.body()).find(), "Response body does not contain expected updated flag.");

    }

    @Test
    @Order(4)
    void test_DeleteUser() throws IOException, InterruptedException {
        HttpResponse<String> response = null;
        HttpRequest.Builder requestBuilder;
        Map<String,String> runtimeVars = new ConcurrentHashMap<>();

        // --- Start Request: DELETE /api/users/$id ---
        String __path = interpolate("/api/users/$id", runtimeVars, globalVars);
        requestBuilder = HttpRequest.newBuilder()
            .uri(URI.create(baseUrl + __path));
        defaultHeaders.forEach(requestBuilder::header);
        // Add specific headers (runtime interpolated)
        requestBuilder.header("Authorization", interpolate("Bearer $token", runtimeVars, globalVars));
        HttpRequest.BodyPublisher bodyPublisher;
        requestBuilder.DELETE();
        response = client.send(requestBuilder.build(), HttpResponse.BodyHandlers.ofString());
        // --- End Request ---

        // Assertion: StatusAssertion
        assertEquals(200, response.statusCode(), "Status code mismatch");

        // Assertion: BodyAssertion
        assertTrue(response.body() != null && Pattern.compile("\\\"deleted\\\"\\s*:\\s*true").matcher(response.body()).find(), "Response body does not contain expected deleted flag.");

    }

}
